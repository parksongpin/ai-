<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"> <meta name="csrf-token" content="{{ csrf|default('') }}">
    <title>노래 추천 결과</title>
    <style>
        body {
            margin: 0;
            padding: 40px;
            font-family: "Noto Sans KR", sans-serif;
            background: linear-gradient(135deg, #fbc2eb, #a6c1ee);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        p {
            font-size: 1.1rem;
            margin: 5px 0;
            background: #ffffffbb;
            padding: 8px 15px;
            border-radius: 10px;
            width: fit-content;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        h2 {
            margin-top: 30px;
            font-size: 1.5rem;
            color: #34495e;
        }

        /* 추천 곡 영역 */
        .recommend-box {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            max-width: 600px;
            text-align: left;
        }

        .song-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .song-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 비율 */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            margin: 10px 0;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        a.back-btn {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 25px;
            background: #6a82fb;
            color: #fff;
            text-decoration: none;
            font-size: 1rem;
            border-radius: 30px;
            transition: 0.3s ease;
            box-shadow: 0 4px 10px rgba(106, 130, 251, 0.4);
        }

        a.back-btn:hover {
            background: #5a72e5;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(106, 130, 251, 0.5);
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .record-save-btn {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 25px;
            background: #28a745;
            color: #fff;
            text-decoration: none;
            font-size: 1rem;
            border-radius: 30px;
            transition: 0.3s ease;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
            border: none;
            cursor: pointer;
        }

        .record-save-btn:hover {
            background: #218838;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.5);
        }
    </style>
</head>
<body>
    <h1>🎶 노래 추천 결과 🎶</h1>

    <p><strong>감정 상태:</strong> <span id="mood-value">{{ mood }}</span></p>

    <h2>추천 곡</h2>
    <div class="recommend-box">
        {% if recommendations %}
            {% for line in recommendations.split('\n') %}
                {% if line and ' - ' in line %}
                    {% set parts = line.split(' - ', 1) %}
                    {% set title = parts[0].strip() %}
                    {% set artist = parts[1].strip() %}
                    <div class="song-item">
                        <div class="song-title">{{ title }} - {{ artist }}</div>
                        <div class="video-container" id="video-{{ loop.index }}">
                            <div class="loading">로딩 중...</div>
                        </div>
                    </div>
                    <script>
                        fetch(`/api/youtube/search?title={{ title | urlencode }}&artist={{ artist | urlencode }}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.videoId) {
                                    const container = document.querySelector('#video-{{ loop.index }}');
                                    container.innerHTML = `
                                        <iframe
                                            src="https://www.youtube.com/embed/${data.videoId}"
                                            frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowfullscreen>
                                        </iframe>
                                    `;
                                } else if (data.error) {
                                    throw new Error(data.error);
                                }
                            })
                            .catch(error => {
                                const container = document.querySelector('#video-{{ loop.index }}');
                                container.innerHTML = `
                                    <div class="error-message">
                                        동영상을 불러올 수 없습니다. (${error.message || '알 수 없는 오류'})
                                    </div>
                                `;
                            });
                    </script>
                {% else %}
                    <div class="song-item">
                        <div class="song-title">{{ line }}</div>
                        <div class="error-message">곡 정보 형식이 올바르지 않음</div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="song-item">
                <div class="error-message">추천 곡이 없습니다.</div>
            </div>
        {% endif %}
    </div>

    <div class="button-container" style="display: flex; gap: 20px; margin-top: 30px;">
        <a href="{{ url_for('survey') }}" class="back-btn">다시 설문하기</a>
        <button class="record-save-btn" onclick="saveRecord()">기록 저장하기</button>
        <button class="record-save-btn" onclick="downloadJson()">내보내기(JSON)</button>
    </div>

    <script>
        function collectRecommendations() {
  const items = [];
  document.querySelectorAll('.song-item').forEach((item) => {
    const titleText = item.querySelector('.song-title')?.textContent?.trim() || '';
    // "제목 - 아티스트" 안전 파싱
    let title = titleText, artist = '';
    const sep = titleText.indexOf(' - ');
    if (sep !== -1) {
      title = titleText.slice(0, sep).trim();
      artist = titleText.slice(sep + 3).trim();
    }

    // videoId 추출(임베드된 iframe src에서)
    const iframe = item.querySelector('iframe');
    let videoId = null;
    if (iframe?.src) {
      try {
        const u = new URL(iframe.src);
        // .../embed/{videoId}?...
        videoId = (u.pathname.split('/').pop() || '').split('?')[0] || null;
      } catch (_) {}
    }

    items.push({
      title, artist, videoId,
      // 확장 필드(있으면 채우고, 없으면 비워도 됨)
      reason: null,
      tags: []  // ["mood","activity","genre"] 형태 권장
    });
  });

  const mood = (document.getElementById('mood-value')?.textContent || '알 수 없음').trim();

  return {
    mood,
    items,
    createdAt: new Date().toISOString(),
    source: "results_page_v1"
  };
}
       async function saveRecord() {
  const payload = collectRecommendations();

  const headers = { 'Content-Type': 'application/json' };
  const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
  if (csrf) headers['X-CSRF-Token'] = csrf;

  try {
    const res = await fetch('/save_record', {
      method: 'POST',
      headers,
      credentials: 'same-origin', // 세션 쿠키 전달
      body: JSON.stringify(payload)
    });

    const contentType = res.headers.get('content-type') || '';
    const body = contentType.includes('application/json') ? await res.json() : await res.text();

    if (res.ok && body?.success) {
      // 성공 → 기록 페이지로
      window.location.href = '/records';
    } else {
      throw new Error(body?.error || '서버 저장 실패');
    }
  } catch (err) {
    console.error('[saveRecord] 실패:', err);
    alert('서버 저장에 실패했습니다. JSON 파일로 백업을 권장합니다.');
  }
}
async function saveRecord() {
  const payload = collectRecommendations();

  const headers = { 'Content-Type': 'application/json' };
  const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
  if (csrf) headers['X-CSRF-Token'] = csrf;

  try {
    const res = await fetch('/save_record', {
      method: 'POST',
      headers,
      credentials: 'same-origin', // 세션 쿠키 전달
      body: JSON.stringify(payload)
    });

    const contentType = res.headers.get('content-type') || '';
    const body = contentType.includes('application/json') ? await res.json() : await res.text();

    if (res.ok && body?.success) {
      // 성공 → 기록 페이지로
      window.location.href = '/records';
    } else {
      throw new Error(body?.error || '서버 저장 실패');
    }
  } catch (err) {
    console.error('[saveRecord] 실패:', err);
    alert('서버 저장에 실패했습니다. JSON 파일로 백업을 권장합니다.');
  }
}
function downloadJson() {
  const data = collectRecommendations();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const stamp = new Date().toISOString().replace(/[:.]/g, '-');
  const a = document.createElement('a');
  a.href = url;
  a.download = `recommendations_${stamp}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
const PENDING_KEY = 'pending_records_v1';

function enqueuePending(payload) {
  const arr = JSON.parse(localStorage.getItem(PENDING_KEY) || '[]');
  arr.push(payload);
  localStorage.setItem(PENDING_KEY, JSON.stringify(arr));
}

async function flushPending() {
  const arr = JSON.parse(localStorage.getItem(PENDING_KEY) || '[]');
  if (!arr.length) return;

  const headers = { 'Content-Type': 'application/json' };
  const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
  if (csrf) headers['X-CSRF-Token'] = csrf;

  const sent = [];
  for (const payload of arr) {
    try {
      const res = await fetch('/save_record', {
        method: 'POST',
        headers,
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });
      if (res.ok) sent.push(payload);
    } catch (_) {}
  }
  if (sent.length) {
    const remaining = arr.filter(p => !sent.includes(p));
    localStorage.setItem(PENDING_KEY, JSON.stringify(remaining));
  }
}
// 페이지 로드시 자동 재시도
window.addEventListener('load', () => { flushPending(); });

// saveRecord 실패 시 큐에 저장하는 예시
async function saveRecord() {
  const payload = collectRecommendations();
  try {
    // ... (위의 fetch 로직)
  } catch (err) {
    enqueuePending(payload);
    alert('서버 저장 실패 → 임시로 로컬에 보관했습니다. 다음 접속 시 자동 재시도합니다.');
  }
}
    </script>
</body>
</html>
