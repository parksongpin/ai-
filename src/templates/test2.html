<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"> <meta name="csrf-token" content="{{ csrf|default('') }}">
    <title>ë…¸ë˜ ì¶”ì²œ ê²°ê³¼</title>
    <style>
        body {
            margin: 0;
            padding: 40px;
            font-family: "Noto Sans KR", sans-serif;
            background: linear-gradient(135deg, #fbc2eb, #a6c1ee);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        p {
            font-size: 1.1rem;
            margin: 5px 0;
            background: #ffffffbb;
            padding: 8px 15px;
            border-radius: 10px;
            width: fit-content;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        h2 {
            margin-top: 30px;
            font-size: 1.5rem;
            color: #34495e;
        }

        /* ì¶”ì²œ ê³¡ ì˜ì—­ */
        .recommend-box {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            max-width: 600px;
            text-align: left;
        }

        .song-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .song-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 ë¹„ìœ¨ */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            margin: 10px 0;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        a.back-btn {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 25px;
            background: #6a82fb;
            color: #fff;
            text-decoration: none;
            font-size: 1rem;
            border-radius: 30px;
            transition: 0.3s ease;
            box-shadow: 0 4px 10px rgba(106, 130, 251, 0.4);
        }

        a.back-btn:hover {
            background: #5a72e5;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(106, 130, 251, 0.5);
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .record-save-btn {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 25px;
            background: #28a745;
            color: #fff;
            text-decoration: none;
            font-size: 1rem;
            border-radius: 30px;
            transition: 0.3s ease;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
            border: none;
            cursor: pointer;
        }

        .record-save-btn:hover {
            background: #218838;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.5);
        }
    </style>
</head>
<body>
    <h1>ğŸ¶ ë…¸ë˜ ì¶”ì²œ ê²°ê³¼ ğŸ¶</h1>

    <p><strong>ê°ì • ìƒíƒœ:</strong> <span id="mood-value">{{ mood }}</span></p>

    <h2>ì¶”ì²œ ê³¡</h2>
    <div class="recommend-box">
        {% if recommendations %}
            {% for line in recommendations.split('\n') %}
                {% if line and ' - ' in line %}
                    {% set parts = line.split(' - ', 1) %}
                    {% set title = parts[0].strip() %}
                    {% set artist = parts[1].strip() %}
                    <div class="song-item">
                        <div class="song-title">{{ title }} - {{ artist }}</div>
                        <div class="video-container" id="video-{{ loop.index }}">
                            <div class="loading">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                    <script>
                        fetch(`/api/youtube/search?title={{ title | urlencode }}&artist={{ artist | urlencode }}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.videoId) {
                                    const container = document.querySelector('#video-{{ loop.index }}');
                                    container.innerHTML = `
                                        <iframe
                                            src="https://www.youtube.com/embed/${data.videoId}"
                                            frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowfullscreen>
                                        </iframe>
                                    `;
                                } else if (data.error) {
                                    throw new Error(data.error);
                                }
                            })
                            .catch(error => {
                                const container = document.querySelector('#video-{{ loop.index }}');
                                container.innerHTML = `
                                    <div class="error-message">
                                        ë™ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'})
                                    </div>
                                `;
                            });
                    </script>
                {% else %}
                    <div class="song-item">
                        <div class="song-title">{{ line }}</div>
                        <div class="error-message">ê³¡ ì •ë³´ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ</div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="song-item">
                <div class="error-message">ì¶”ì²œ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        {% endif %}
    </div>

    <div class="button-container" style="display: flex; gap: 20px; margin-top: 30px;">
        <a href="{{ url_for('survey') }}" class="back-btn">ë‹¤ì‹œ ì„¤ë¬¸í•˜ê¸°</a>
        <button class="record-save-btn" onclick="saveRecord()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
        <button class="record-save-btn" onclick="downloadJson()">ë‚´ë³´ë‚´ê¸°(JSON)</button>
    </div>

    <script>
        function collectRecommendations() {
  const items = [];
  document.querySelectorAll('.song-item').forEach((item) => {
    const titleText = item.querySelector('.song-title')?.textContent?.trim() || '';
    // "ì œëª© - ì•„í‹°ìŠ¤íŠ¸" ì•ˆì „ íŒŒì‹±
    let title = titleText, artist = '';
    const sep = titleText.indexOf(' - ');
    if (sep !== -1) {
      title = titleText.slice(0, sep).trim();
      artist = titleText.slice(sep + 3).trim();
    }

    // videoId ì¶”ì¶œ(ì„ë² ë“œëœ iframe srcì—ì„œ)
    const iframe = item.querySelector('iframe');
    let videoId = null;
    if (iframe?.src) {
      try {
        const u = new URL(iframe.src);
        // .../embed/{videoId}?...
        videoId = (u.pathname.split('/').pop() || '').split('?')[0] || null;
      } catch (_) {}
    }

    items.push({
      title, artist, videoId,
      // í™•ì¥ í•„ë“œ(ìˆìœ¼ë©´ ì±„ìš°ê³ , ì—†ìœ¼ë©´ ë¹„ì›Œë„ ë¨)
      reason: null,
      tags: []  // ["mood","activity","genre"] í˜•íƒœ ê¶Œì¥
    });
  });

  const mood = (document.getElementById('mood-value')?.textContent || 'ì•Œ ìˆ˜ ì—†ìŒ').trim();

  return {
    mood,
    items,
    createdAt: new Date().toISOString(),
    source: "results_page_v1"
  };
}
       async function saveRecord() {
  const payload = collectRecommendations();

  const headers = { 'Content-Type': 'application/json' };
  const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
  if (csrf) headers['X-CSRF-Token'] = csrf;

  try {
    const res = await fetch('/save_record', {
      method: 'POST',
      headers,
      credentials: 'same-origin', // ì„¸ì…˜ ì¿ í‚¤ ì „ë‹¬
      body: JSON.stringify(payload)
    });

    const contentType = res.headers.get('content-type') || '';
    const body = contentType.includes('application/json') ? await res.json() : await res.text();

    if (res.ok && body?.success) {
      // ì„±ê³µ â†’ ê¸°ë¡ í˜ì´ì§€ë¡œ
      window.location.href = '/records';
    } else {
      throw new Error(body?.error || 'ì„œë²„ ì €ì¥ ì‹¤íŒ¨');
    }
  } catch (err) {
    console.error('[saveRecord] ì‹¤íŒ¨:', err);
    alert('ì„œë²„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. JSON íŒŒì¼ë¡œ ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.');
  }
}
async function saveRecord() {
  const payload = collectRecommendations();

  const headers = { 'Content-Type': 'application/json' };
  const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
  if (csrf) headers['X-CSRF-Token'] = csrf;

  try {
    const res = await fetch('/save_record', {
      method: 'POST',
      headers,
      credentials: 'same-origin', // ì„¸ì…˜ ì¿ í‚¤ ì „ë‹¬
      body: JSON.stringify(payload)
    });

    const contentType = res.headers.get('content-type') || '';
    const body = contentType.includes('application/json') ? await res.json() : await res.text();

    if (res.ok && body?.success) {
      // ì„±ê³µ â†’ ê¸°ë¡ í˜ì´ì§€ë¡œ
      window.location.href = '/records';
    } else {
      throw new Error(body?.error || 'ì„œë²„ ì €ì¥ ì‹¤íŒ¨');
    }
  } catch (err) {
    console.error('[saveRecord] ì‹¤íŒ¨:', err);
    alert('ì„œë²„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. JSON íŒŒì¼ë¡œ ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.');
  }
}
function downloadJson() {
  const data = collectRecommendations();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const stamp = new Date().toISOString().replace(/[:.]/g, '-');
  const a = document.createElement('a');
  a.href = url;
  a.download = `recommendations_${stamp}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
const PENDING_KEY = 'pending_records_v1';

function enqueuePending(payload) {
  const arr = JSON.parse(localStorage.getItem(PENDING_KEY) || '[]');
  arr.push(payload);
  localStorage.setItem(PENDING_KEY, JSON.stringify(arr));
}

async function flushPending() {
  const arr = JSON.parse(localStorage.getItem(PENDING_KEY) || '[]');
  if (!arr.length) return;

  const headers = { 'Content-Type': 'application/json' };
  const csrf = document.querySelector('meta[name="csrf-token"]')?.content;
  if (csrf) headers['X-CSRF-Token'] = csrf;

  const sent = [];
  for (const payload of arr) {
    try {
      const res = await fetch('/save_record', {
        method: 'POST',
        headers,
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });
      if (res.ok) sent.push(payload);
    } catch (_) {}
  }
  if (sent.length) {
    const remaining = arr.filter(p => !sent.includes(p));
    localStorage.setItem(PENDING_KEY, JSON.stringify(remaining));
  }
}
// í˜ì´ì§€ ë¡œë“œì‹œ ìë™ ì¬ì‹œë„
window.addEventListener('load', () => { flushPending(); });

// saveRecord ì‹¤íŒ¨ ì‹œ íì— ì €ì¥í•˜ëŠ” ì˜ˆì‹œ
async function saveRecord() {
  const payload = collectRecommendations();
  try {
    // ... (ìœ„ì˜ fetch ë¡œì§)
  } catch (err) {
    enqueuePending(payload);
    alert('ì„œë²„ ì €ì¥ ì‹¤íŒ¨ â†’ ì„ì‹œë¡œ ë¡œì»¬ì— ë³´ê´€í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì ‘ì† ì‹œ ìë™ ì¬ì‹œë„í•©ë‹ˆë‹¤.');
  }
}
    </script>
</body>
</html>
