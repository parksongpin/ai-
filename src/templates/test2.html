<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë…¸ë˜ ì¶”ì²œ ê²°ê³¼</title>
    <style>
        body {
            margin: 0;
            padding: 40px;
            font-family: "Noto Sans KR", sans-serif;
            background: linear-gradient(135deg, #fbc2eb, #a6c1ee);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        p {
            font-size: 1.1rem;
            margin: 5px 0;
            background: #ffffffbb;
            padding: 8px 15px;
            border-radius: 10px;
            width: fit-content;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        h2 {
            margin-top: 30px;
            font-size: 1.5rem;
            color: #34495e;
        }

        /* ì¶”ì²œ ê³¡ ì˜ì—­ */
        .recommend-box {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            max-width: 600px;
            text-align: left;
        }

        .song-item {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .song-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 ë¹„ìœ¨ */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            margin: 10px 0;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        a.back-btn {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 25px;
            background: #6a82fb;
            color: #fff;
            text-decoration: none;
            font-size: 1rem;
            border-radius: 30px;
            transition: 0.3s ease;
            box-shadow: 0 4px 10px rgba(106, 130, 251, 0.4);
        }

        a.back-btn:hover {
            background: #5a72e5;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(106, 130, 251, 0.5);
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¶ ë…¸ë˜ ì¶”ì²œ ê²°ê³¼ ğŸ¶</h1>

    <p><strong>ê°ì • ìƒíƒœ:</strong> <span id="mood-value">{{ mood }}</span></p>

    <h2>ì¶”ì²œ ê³¡</h2>
    <div class="recommend-box">
        {% if recommendations %}
            {% for line in recommendations.split('\n') %}
                {% if line and ' - ' in line %}
                    {% set parts = line.split(' - ', 1) %}
                    {% set title = parts[0].strip() %}
                    {% set artist = parts[1].strip() %}
                    <div class="song-item">
                        <div class="song-title">{{ title }} - {{ artist }}</div>
                        <div class="video-container" id="video-{{ loop.index }}">
                            <div class="loading">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                    <script>
                        fetch(`/api/youtube/search?title={{ title | urlencode }}&artist={{ artist | urlencode }}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.videoId) {
                                    const container = document.querySelector('#video-{{ loop.index }}');
                                    container.innerHTML = `
                                        <iframe
                                            src="https://www.youtube.com/embed/${data.videoId}"
                                            frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowfullscreen>
                                        </iframe>
                                    `;
                                } else if (data.error) {
                                    throw new Error(data.error);
                                }
                            })
                            .catch(error => {
                                const container = document.querySelector('#video-{{ loop.index }}');
                                container.innerHTML = `
                                    <div class="error-message">
                                        ë™ì˜ìƒì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'})
                                    </div>
                                `;
                            });
                    </script>
                {% else %}
                    <div class="song-item">
                        <div class="song-title">{{ line }}</div>
                        <div class="error-message">ê³¡ ì •ë³´ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ</div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="song-item">
                <div class="error-message">ì¶”ì²œ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        {% endif %}
    </div>

    <div class="button-container" style="display: flex; gap: 20px; margin-top: 30px;">
        <a href="{{ url_for('survey') }}" class="back-btn">ë‹¤ì‹œ ì„¤ë¬¸í•˜ê¸°</a>
        <button class="back-btn" onclick="saveRecord()" style="border: none; cursor: pointer;">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
    </div>

    <script>
        function saveRecord() {
            // í˜„ì¬ ì¶”ì²œ ëª©ë¡ê³¼ ê°ì • ìƒíƒœë¥¼ ìˆ˜ì§‘
            const recommendations = [];
            document.querySelectorAll('.song-title').forEach(el => {
                recommendations.push(el.textContent.trim());
            });
            // ê°ì • ìƒíƒœë¥¼ ì°¾ì•„ ì¶”ì¶œ
            let feeling = document.getElementById('mood-value').textContent;
            if (!feeling || feeling.trim() === '') {
                feeling = 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
            feeling = feeling.trim();
            console.log('ê°ì •:', feeling); // ë””ë²„ê¹…ìš©
            console.log('ì¶”ì²œê³¡:', recommendations); // ë””ë²„ê¹…ìš©

            // ì¶”ì²œê³¡ ë°ì´í„° ì •ì œ
            const cleanedRecommendations = recommendations.filter(r => r && r.trim() !== '');
            
            const requestData = {
                feeling: feeling,
                recommendations: cleanedRecommendations
            };
            console.log('ì „ì†¡í•  ë°ì´í„°:', requestData); // ë””ë²„ê¹…ìš©

            // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
            fetch('/save_record', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(async response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json().then(data => ({status: response.status, body: data}));
                } else {
                    return response.text().then(text => ({status: response.status, body: text}));
                }
            })
            .then(({status, body}) => {
                console.log('ì„œë²„ ì‘ë‹µ:', status, body); // ë””ë²„ê¹…ìš©
                if (status === 200 && body.success) {
                    window.location.href = '/records';  // ì„±ê³µí•˜ë©´ ê¸°ë¡ í˜ì´ì§€ë¡œ ì´ë™
                } else {
                    const errorMessage = body.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    alert('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + errorMessage);
                    console.error('ì €ì¥ ì‹¤íŒ¨:', body);
                }
            })
            .catch(error => {
                console.error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                alert('ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ë„êµ¬ì˜ ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            });
        }
    </script>
</body>
</html>
